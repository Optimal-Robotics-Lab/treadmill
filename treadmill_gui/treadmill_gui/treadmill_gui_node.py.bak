import sys
import rclpy
from rclpy.node import Node
from std_msgs.msg import Float32, String
from treadmill_interfaces.msg import TreadmillStatus

from PyQt6.QtWidgets import (
    QApplication,
    QMainWindow,
    QWidget,
    QVBoxLayout,
    QHBoxLayout,
    QPushButton,
    QLabel,
    QLineEdit,
    QMessageBox,
    QGridLayout,
    QGroupBox,
    QSizePolicy,
)
from PyQt6.QtCore import QTimer, Qt, QSize
from PyQt6.QtGui import QFont, QPalette, QColor
from matplotlib.backends.backend_qtagg import FigureCanvasQTAgg as FigureCanvas
from matplotlib.figure import Figure


class TreadmillGUI(Node):
    """Professional Treadmill Control GUI with ROS2 integration"""

    # Style constants
    COLORS = {
        "primary": "#2196F3",
        "success": "#4CAF50",
        "danger": "#F44336",
        "warning": "#FF9800",
        "bg_dark": "#263238",
        "bg_light": "#ECEFF1",
        "text_dark": "#212121",
        "text_light": "#FFFFFF",
        "border": "#CFD8DC",
    }

    def __init__(self):
        # Initialize ROS 2 Node first
        super().__init__("treadmill_gui_node")

        # Create the main window
        self.window = QMainWindow()
        self.window.setWindowTitle("Treadmill Control System")
        self.window.setMinimumSize(1200, 800)

        # Error and alarm databases
        self._init_error_databases()

        # State variables
        self.current_speed_mps = 0.0
        self.set_speed_mps = 0.0
        self.distance_traveled = 0.0
        self.time_running = 0.0
        self.is_powered_on = False
        self.is_stopped = True
        self.last_error = ""
        self.speed_history = []
        self.time_history = []
        self.active_timer = None

        # Setup UI and ROS
        self._apply_global_styles()
        self._init_ui()
        self._init_ros()

        # Update GUI timer (100ms)
        self.timer = QTimer()
        self.timer.timeout.connect(self._update_gui_loop)
        self.timer.start(100)

    def _init_error_databases(self):
        """Initialize fault and alarm code databases"""
        self.faults = {
            6: {
                "desc": "Imbalance or Input Phase Loss",
                "causes": "Mains voltage imbalance > 5%.",
            },
            21: {
                "desc": "DC Link Undervoltage",
                "causes": "Input voltage too low; Phase loss.",
            },
            22: {
                "desc": "DC Link Overvoltage",
                "causes": "Inertia too high; Decel time too short.",
            },
            30: {
                "desc": "Power Module U Fault",
                "causes": "Short-circuit between phases.",
            },
            34: {
                "desc": "Power Module V Fault",
                "causes": "Short-circuit between phases.",
            },
            38: {
                "desc": "Power Module W Fault",
                "causes": "Short-circuit between phases.",
            },
            42: {
                "desc": "DB IGBT Fault",
                "causes": "Short-circuit in braking resistor.",
            },
            48: {
                "desc": "IGBT Overload Fault",
                "causes": "High current; check switching freq.",
            },
            51: {
                "desc": "IGBT Overtemperature",
                "causes": "NTC sensors detected high heat.",
            },
            71: {
                "desc": "Output Overcurrent",
                "causes": "Excessive load; Accel time too short.",
            },
            72: {"desc": "Motor Overload", "causes": "Motor shaft load is excessive."},
            74: {
                "desc": "Ground Fault",
                "causes": "Short circuit to ground in motor/cables.",
            },
            78: {
                "desc": "Motor Overtemperature",
                "causes": "Excessive duty cycle; Ambient temp high.",
            },
            156: {"desc": "Undertemperature", "causes": "Air temperature <= -30 °C."},
            185: {
                "desc": "Pre-charge Contactor Fault",
                "causes": "Phase loss; Contactor defect.",
            },
        }

        self.alarms = {
            46: {"desc": "High Load on Motor", "causes": "Motor shaft load excessive."},
            47: {
                "desc": "IGBT Overload Alarm",
                "causes": "High current at inverter output.",
            },
            50: {
                "desc": "IGBT High Temperature",
                "causes": "Ambient temp > 45°C; Fan blocked.",
            },
            88: {"desc": "Communication Lost", "causes": "Loose keypad cable; Noise."},
            90: {
                "desc": "External Alarm",
                "causes": "External safety input triggered.",
            },
            110: {"desc": "High Motor Temperature", "causes": "Excessive shaft load."},
            128: {
                "desc": "Timeout for Serial Communication",
                "causes": "No valid messages; Check wiring.",
            },
            152: {
                "desc": "Internal Air High Temperature",
                "causes": "Internal fan defective.",
            },
            177: {"desc": "Fan Replacement", "causes": "Heatsink fan > 50,000 hours."},
            702: {
                "desc": "Inverter Disabled",
                "causes": "General Enable command not active.",
            },
        }

    def _apply_global_styles(self):
        """Apply global stylesheet to the application"""
        style = f"""
            QMainWindow {{
                background-color: {self.COLORS["bg_light"]};
            }}
            
            QGroupBox {{
                font-weight: bold;
                font-size: 14px;
                border: 2px solid {self.COLORS["border"]};
                border-radius: 6px;
                margin-top: 12px;
                padding-top: 10px;
            }}
            
            QGroupBox::title {{
                subcontrol-origin: margin;
                left: 10px;
                padding: 0 5px;
            }}
            
            QPushButton {{
                border: none;
                border-radius: 6px;
                padding: 12px 24px;
                font-size: 13px;
                font-weight: 600;
                min-height: 40px;
            }}
            
            QPushButton:hover {{
                opacity: 0.9;
            }}
            
            QPushButton:pressed {{
                opacity: 0.8;
            }}
            
            QPushButton:disabled {{
                background-color: #BDBDBD;
                color: #757575;
            }}
            
            QLineEdit {{
                border: 2px solid {self.COLORS["border"]};
                border-radius: 6px;
                padding: 10px;
                font-size: 13px;
                background-color: white;
            }}
            
            QLineEdit:focus {{
                border: 2px solid {self.COLORS["primary"]};
            }}
            
            QLabel {{
                color: {self.COLORS["text_dark"]};
            }}
        """
        self.window.setStyleSheet(style)

    def _init_ros(self):
        """Initialize ROS2 publishers and subscribers"""
        self.pub_speed = self.create_publisher(Float32, "treadmill/cmd_speed_mps", 10)
        self.pub_cmd = self.create_publisher(String, "treadmill/special_cmd", 10)
        self.sub_status = self.create_subscription(
            TreadmillStatus, "treadmill/status", self._status_callback, 10
        )

    def _init_ui(self):
        """Initialize the user interface"""
        central_widget = QWidget()
        self.window.setCentralWidget(central_widget)
        main_layout = QHBoxLayout(central_widget)
        main_layout.setSpacing(20)
        main_layout.setContentsMargins(20, 20, 20, 20)

        # Left panel - Control section
        left_panel = self._create_control_panel()

        # Middle panel - Display section
        middle_panel = self._create_display_panel()

        # Right panel - Graph section
        right_panel = self._create_graph_panel()

        # Add panels to main layout with stretch factors
        main_layout.addWidget(left_panel, 2)
        main_layout.addWidget(middle_panel, 2)
        main_layout.addWidget(right_panel, 3)

    def _create_control_panel(self):
        """Create the control panel with all buttons"""
        group = QGroupBox("Controls")
        layout = QVBoxLayout()
        layout.setSpacing(15)

        # Power button
        self.btn_power = QPushButton("POWER ON")
        self.btn_power.setStyleSheet(f"""
            QPushButton {{
                background-color: {self.COLORS["success"]};
                color: {self.COLORS["text_light"]};
                font-size: 14px;
                min-height: 50px;
            }}
            QPushButton:hover {{
                background-color: #45a049;
            }}
        """)
        self.btn_power.clicked.connect(self._toggle_power)

        # Speed adjustment section
        speed_group = QGroupBox("Speed Adjustment")
        speed_layout = QVBoxLayout()
        speed_layout.setSpacing(10)

        # Fine adjustment
        fine_label = QLabel("Fine Control (±0.01 m/s)")
        fine_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        fine_label.setStyleSheet("font-weight: normal; font-size: 12px;")

        fine_buttons = QHBoxLayout()
        fine_buttons.setSpacing(10)

        self.btn_dn_small = self._create_speed_button(
            "- 0.01", lambda: self._adjust_speed(-0.01)
        )
        self.btn_up_small = self._create_speed_button(
            "+ 0.01", lambda: self._adjust_speed(0.01)
        )

        fine_buttons.addWidget(self.btn_dn_small)
        fine_buttons.addWidget(self.btn_up_small)

        # Coarse adjustment
        coarse_label = QLabel("Coarse Control (±0.1 m/s)")
        coarse_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        coarse_label.setStyleSheet("font-weight: normal; font-size: 12px;")

        coarse_buttons = QHBoxLayout()
        coarse_buttons.setSpacing(10)

        self.btn_dn_large = self._create_speed_button(
            "- 0.1", lambda: self._adjust_speed(-0.1)
        )
        self.btn_up_large = self._create_speed_button(
            "+ 0.1", lambda: self._adjust_speed(0.1)
        )

        coarse_buttons.addWidget(self.btn_dn_large)
        coarse_buttons.addWidget(self.btn_up_large)

        speed_layout.addWidget(fine_label)
        speed_layout.addLayout(fine_buttons)
        speed_layout.addWidget(coarse_label)
        speed_layout.addLayout(coarse_buttons)
        speed_group.setLayout(speed_layout)

        # Manual speed entry
        manual_group = QGroupBox("Manual Speed Entry")
        manual_layout = QVBoxLayout()

        self.speed_input = QLineEdit()
        self.speed_input.setPlaceholderText("Enter speed (m/s)")
        self.speed_input.returnPressed.connect(self._manual_speed_entry)

        manual_layout.addWidget(self.speed_input)
        manual_group.setLayout(manual_layout)

        # Stop button
        self.btn_stop = QPushButton("EMERGENCY STOP")
        self.btn_stop.setStyleSheet(f"""
            QPushButton {{
                background-color: {self.COLORS["danger"]};
                color: {self.COLORS["text_light"]};
                font-size: 15px;
                font-weight: bold;
                min-height: 60px;
            }}
            QPushButton:hover {{
                background-color: #da190b;
            }}
        """)
        self.btn_stop.clicked.connect(self._handle_stop)

        # Reset button
        self.btn_reset = QPushButton("RESET SYSTEM")
        self.btn_reset.setStyleSheet(f"""
            QPushButton {{
                background-color: {self.COLORS["warning"]};
                color: {self.COLORS["text_light"]};
                font-size: 14px;
                min-height: 50px;
            }}
            QPushButton:hover {{
                background-color: #e68900;
            }}
        """)
        self.btn_reset.clicked.connect(self._handle_reset)

        # Add all components to layout
        layout.addWidget(self.btn_power)
        layout.addWidget(speed_group)
        layout.addWidget(manual_group)
        layout.addStretch()
        layout.addWidget(self.btn_stop)
        layout.addWidget(self.btn_reset)

        group.setLayout(layout)
        return group

    def _create_speed_button(self, text, callback):
        """Create a styled speed adjustment button"""
        btn = QPushButton(text)
        btn.setStyleSheet(f"""
            QPushButton {{
                background-color: {self.COLORS["primary"]};
                color: {self.COLORS["text_light"]};
                font-size: 13px;
            }}
            QPushButton:hover {{
                background-color: #1976D2;
            }}
        """)
        btn.pressed.connect(lambda: self._start_speed_timer(callback))
        btn.released.connect(self._stop_speed_timer)
        return btn

    def _create_display_panel(self):
        """Create the display panel showing current metrics"""
        group = QGroupBox("Status Display")
        layout = QVBoxLayout()
        layout.setSpacing(20)

        # Create display labels
        self.lbl_curr_speed = self._create_display_label("Current Speed", "0.00 m/s")
        self.lbl_set_speed = self._create_display_label("Target Speed", "0.00 m/s")
        self.lbl_dist = self._create_display_label("Distance", "0.00 m")
        self.lbl_time = self._create_display_label("Running Time", "0.0 s")

        # Add labels to layout
        for lbl_title, lbl_value in [
            self.lbl_curr_speed,
            self.lbl_set_speed,
            self.lbl_dist,
            self.lbl_time,
        ]:
            metric_layout = QVBoxLayout()
            metric_layout.setSpacing(5)
            metric_layout.addWidget(lbl_title)
            metric_layout.addWidget(lbl_value)
            layout.addLayout(metric_layout)

        layout.addStretch()

        group.setLayout(layout)
        return group

    def _create_display_label(self, title, initial_value):
        """Create a title and value label pair for metrics"""
        title_label = QLabel(title)
        title_label.setStyleSheet("""
            font-size: 13px;
            font-weight: normal;
            color: #757575;
        """)

        value_label = QLabel(initial_value)
        value_label.setStyleSheet(f"""
            font-size: 32px;
            font-weight: bold;
            color: {self.COLORS["text_dark"]};
            font-family: 'Consolas', 'Monaco', monospace;
        """)

        return (title_label, value_label)

    def _create_graph_panel(self):
        """Create the graph panel for speed visualization"""
        group = QGroupBox("Speed Profile")
        layout = QVBoxLayout()

        # Create matplotlib figure
        self.fig = Figure(figsize=(6, 5), dpi=100, facecolor="white")
        self.canvas = FigureCanvas(self.fig)
        self.canvas.setSizePolicy(
            QSizePolicy.Policy.Expanding, QSizePolicy.Policy.Expanding
        )

        self.ax = self.fig.add_subplot(111)
        self.ax.set_title("Speed vs Time", fontsize=14, fontweight="bold", pad=15)
        self.ax.set_xlabel("Time (s)", fontsize=11)
        self.ax.set_ylabel("Speed (m/s)", fontsize=11)
        self.ax.grid(True, alpha=0.3, linestyle="--")
        self.ax.set_facecolor("#FAFAFA")

        (self.line,) = self.ax.plot([], [], "b-", linewidth=2, label="Actual Speed")
        self.ax.legend(loc="upper left", fontsize=10)

        self.fig.tight_layout()

        layout.addWidget(self.canvas)
        group.setLayout(layout)
        return group

    def _start_speed_timer(self, func):
        """Start continuous speed adjustment while button is held"""
        func()  # Execute once immediately
        self.active_timer = QTimer()
        self.active_timer.setInterval(200)  # 5 per second
        self.active_timer.timeout.connect(func)
        self.active_timer.start()

    def _stop_speed_timer(self):
        """Stop continuous speed adjustment"""
        if self.active_timer:
            self.active_timer.stop()
            self.active_timer = None

    def _status_callback(self, msg):
        """Handle incoming treadmill status messages"""
        self.current_speed_mps = abs(msg.speed_mps)

        # Handle new errors
        if msg.error and msg.error != self.last_error:
            self.last_error = msg.error
            self._handle_error_popup(msg.error)

    def _handle_error_popup(self, error_str):
        """Display error/alarm popup with details"""
        if not error_str:
            return

        prefix = error_str[0]
        try:
            code = int(error_str[1:])
        except (ValueError, IndexError):
            return

        details = self.faults.get(code) if prefix == "F" else self.alarms.get(code)

        if details:
            msg_box = QMessageBox(self.window)

            if prefix == "F":
                msg_box.setIcon(QMessageBox.Icon.Critical)
                msg_box.setWindowTitle(f"FAULT {prefix}{code:03d}")
            else:
                msg_box.setIcon(QMessageBox.Icon.Warning)
                msg_box.setWindowTitle(f"ALARM {prefix}{code:03d}")

            msg_box.setText(f"<b>{details['desc']}</b>")
            msg_box.setInformativeText(
                f"<p><b>Possible Causes:</b></p><p>{details['causes']}</p>"
            )
            msg_box.setStandardButtons(QMessageBox.StandardButton.Ok)
            msg_box.exec()

    def _update_gui_loop(self):
        """Main GUI update loop - called every 100ms"""
        # Process ROS callbacks
        rclpy.spin_once(self, timeout_sec=0)

        # Update time, distance, and graph when running
        if self.is_powered_on and not self.is_stopped and self.set_speed_mps != 0:
            self.time_running += 0.1
            self.distance_traveled += self.current_speed_mps * 0.1

            self.time_history.append(self.time_running)
            self.speed_history.append(self.current_speed_mps)

            # Limit history to last 300 points (30 seconds)
            if len(self.time_history) > 300:
                self.time_history.pop(0)
                self.speed_history.pop(0)

            # Update graph
            self.line.set_data(self.time_history, self.speed_history)
            self.ax.relim()
            self.ax.autoscale_view()
            self.canvas.draw()

        # Update display labels
        _, self.lbl_curr_speed[1].setText(f"{self.current_speed_mps:.2f} m/s")
        _, self.lbl_set_speed[1].setText(f"{self.set_speed_mps:.2f} m/s")
        _, self.lbl_dist[1].setText(f"{self.distance_traveled:.2f} m")
        _, self.lbl_time[1].setText(f"{self.time_running:.1f} s")

    def _toggle_power(self):
        """Toggle treadmill power on/off"""
        self.is_powered_on = not self.is_powered_on

        cmd = "power_on" if self.is_powered_on else "power_off"
        self.pub_cmd.publish(String(data=cmd))

        if self.is_powered_on:
            self.btn_power.setText("POWER OFF")
            self.btn_power.setStyleSheet(f"""
                QPushButton {{
                    background-color: {self.COLORS["danger"]};
                    color: {self.COLORS["text_light"]};
                    font-size: 14px;
                    min-height: 50px;
                }}
                QPushButton:hover {{
                    background-color: #da190b;
                }}
            """)
        else:
            self.btn_power.setText("POWER ON")
            self.btn_power.setStyleSheet(f"""
                QPushButton {{
                    background-color: {self.COLORS["success"]};
                    color: {self.COLORS["text_light"]};
                    font-size: 14px;
                    min-height: 50px;
                }}
                QPushButton:hover {{
                    background-color: #45a049;
                }}
            """)

    def _handle_stop(self):
        """Handle emergency stop button press"""
        self.is_stopped = True
        self.set_speed_mps = 0.0
        self.pub_cmd.publish(String(data="stop"))
        self.pub_speed.publish(Float32(data=0.0))

    def _handle_reset(self):
        """Reset the entire system"""
        # Power cycle
        self.pub_cmd.publish(String(data="power_off"))
        QTimer.singleShot(500, lambda: self.pub_cmd.publish(String(data="power_on")))

        # Reset fault
        self.pub_cmd.publish(String(data="reset_fault"))

        # Reset internal state
        self.time_running = 0.0
        self.distance_traveled = 0.0
        self.set_speed_mps = 0.0
        self.last_error = ""
        self.speed_history.clear()
        self.time_history.clear()

        # Clear graph
        self.ax.clear()
        self.ax.set_title("Speed vs Time", fontsize=14, fontweight="bold", pad=15)
        self.ax.set_xlabel("Time (s)", fontsize=11)
        self.ax.set_ylabel("Speed (m/s)", fontsize=11)
        self.ax.grid(True, alpha=0.3, linestyle="--")
        self.ax.set_facecolor("#FAFAFA")
        (self.line,) = self.ax.plot([], [], "b-", linewidth=2, label="Actual Speed")
        self.ax.legend(loc="upper left", fontsize=10)
        self.canvas.draw()

    def _adjust_speed(self, delta):
        """Adjust speed by delta amount"""
        if not self.is_powered_on:
            return

        self.is_stopped = False
        self.set_speed_mps = max(0.0, self.set_speed_mps + delta)
        self.pub_speed.publish(Float32(data=self.set_speed_mps))
        self.pub_cmd.publish(String(data="go"))

    def _manual_speed_entry(self):
        """Handle manual speed entry via text input"""
        try:
            val = float(self.speed_input.text())

            if val < 0:
                raise ValueError("Speed must be non-negative")

            self.set_speed_mps = val
            self.is_stopped = False
            self.pub_speed.publish(Float32(data=val))
            self.pub_cmd.publish(String(data="go"))
            self.speed_input.clear()

        except ValueError as e:
            msg_box = QMessageBox(self.window)
            msg_box.setIcon(QMessageBox.Icon.Warning)
            msg_box.setWindowTitle("Invalid Input")
            msg_box.setText("Please enter a valid non-negative number for speed.")
            msg_box.exec()
            self.speed_input.clear()


def main():
    """Main entry point"""
    rclpy.init()
    app = QApplication(sys.argv)

    # Set application-wide font
    font = QFont("Segoe UI", 10)
    app.setFont(font)

    # Create and show GUI
    gui_node = TreadmillGUI()
    gui_node.window.show()

    try:
        sys.exit(app.exec())
    finally:
        gui_node.destroy_node()
        rclpy.shutdown()


if __name__ == "__main__":
    main()
